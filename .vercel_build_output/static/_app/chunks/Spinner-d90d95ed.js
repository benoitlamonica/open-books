var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,c=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&a(e,n,t[n]);if(r)for(var n of r(t))s.call(t,n)&&a(e,n,t[n]);return e};import{C as i,T as u,S as l,i as f,s as E,U as b,e as m,j as p,c as O,a as B,m as d,d as g,b as h,f as $,o as C,x as T,u as N,v as R}from"./vendor-f155ec50.js";var D=i(null);function w(e,t){return fetch(e,t).then((e=>{if(!e.ok)throw new Error(e.statusText);return e.url.endsWith(".xml")?e.text():e.json()}))}const y=["code","nom","departement","region","population"];const j="https://geo.api.gouv.fr";function v(e){const t=function(e){return`communes?${[`nom="${e}"`,`fields=${y.join(",")}`,"boost=population"].join("&")}`}(e);return w(`${j}/${t}`)}function S(e){const t=`communes/${e}?fields=${y.join(",")}`;return w(`${j}/${t}`)}function I(e,t){return`${e}_${t}`}function F({name:e,insee:t,siret:n,sirens:r,year:o}){return`/budgets?name=${e}&insee=${t}&siret=${n}&sirens=${r.join(",")}&year=${o}`}function L(e){return e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}function x(e){return new Intl.NumberFormat("fr",{style:"currency",notation:"compact",currency:"EUR"}).format(e)}const P=["-"," de"];function U(e,t){return e.reduce(((e,n)=>e+n[t]),0)}function z(e){return e.split("").map(((e,t,n)=>t>0?n[t-1]+e:e))}const{json2csvAsync:A}=u,_=["EXER","IDENT","NDEPT","LBUDG","INSEE","CBUDG","CTYPE","CSTYP","NOMEN","SIREN","CREGI","CACTI","SECTEUR","FINESS","CODBUD1","CATEG","BAL","FONCTION","COMPTE","BEDEB","BECRE","OBNETDEB","OBNETCRE","ONBDEB","ONBCRE","OOBDEB","OOBCRE","SD","SC"].map((e=>e.toLowerCase()));async function M(e){const{city:t,label:n,records:r}=e,o=[...new Set(r.map((e=>e.exer)))],s=1===o.length?o[0]:null,a=[...new Set(r.map((e=>e.ident)))],c=1===a.length?a[0]:null;let i=`budget_${t.toLowerCase()}`;n&&(i+=`_${n.split(" ").join("_")}`),c&&(i+=`_${c}`),s&&(i+=`_${s}`),i+=".csv";const u=await A(r,{keys:_}),l=new Blob([u],{type:"text/csv"});return{file:i,url:URL.createObjectURL(l)}}function G(e){const{city:t,siret:n,year:r,records:o}=e,s=o.length;if(0===s)return null;const a=function(e){return e.substring(0,9)}(n),c=function(e){return e.substring(9)}(n),i=U(o,Y.OBNETDEB),u=U(o,Y.OBNETCRE),l=[...new Set(o.map((e=>e.lbudg.toLowerCase())))],f=[...new Set(o.map((e=>e.nomen)))];l.length>1&&console.log("More than 1 label for",n,r),f.length>1&&console.log("More than 1 nomen for",n,r);const E=l.length>0?function(e,t){const n=L(e),r=L(t.toLowerCase());if(n===r)return"commune";let o=e.replace(r,"").trim().toLowerCase();return P.forEach((e=>{o=o.replace(new RegExp(`${e}$`),"")})),o}(l[0],t):"";return{siret:n,siren:a,etabl:c,city:t,year:r,nomen:f.length>0?f[0]:"",length:s,obnetdeb:i,obnetcre:u,label:E,records:o}}function k(e){return[...new Set(e.map((({ident:e})=>e)))].map((t=>{const n=e.filter((({ident:e})=>e===t));return{siret:t,records:n}})).sort(((e,t)=>parseInt(e.siret)-parseInt(t.siret)))}function q(e){if("RefFonc"!==e.tagName&&"RefFonctionnelles"!==e.tagName)throw`${e.tagName} Not a <RefFonc> or a <RefFonctionnelle>`;const t=[...e.children].map((e=>{const t=e.getAttribute("Code"),n=e.getAttribute("Libelle"),r=e.getAttribute("Lib_court"),o={code:t,label:n};return n!==r&&(o.short=r),e.children.length>0&&(o.subTree=q(e)),[t,o]}));return 0===t.length?null:Object.fromEntries(t)}function W(e){const t=(new DOMParser).parseFromString(e,"application/xml").querySelector("RefFonctionnelles");if(!t)throw"No <RefFonctionnelles> found";return q(t)}var Y,V,X,H;(V=Y||(Y={})).OBNETDEB="obnetdeb",V.OBNETCRE="obnetcre",V.OOBDEB="oobdeb",V.OOBCRE="oobcre",(H=X||(X={})).DEBIT="obnetdeb",H.CREDIT="obnetcre";const J={[X.DEBIT]:"DÃ©penses",[X.CREDIT]:"Recettes"};function K(e,t){return e in t?t[e]:K(e,t[e[0]].subTree)}function Q(e,r){const o=Object.values(r).map((r=>{let o,s,a,i,u,{code:l,subTree:f}=r;const E=e.filter((e=>{var t;return null==(t=e.fonction)?void 0:t.startsWith(l)}));if(f){u=Q(E,f);const e=Object.values(u);o=U(e,Y.OBNETDEB),s=U(e,Y.OBNETCRE),a=U(e,Y.OOBDEB),i=U(e,Y.OOBCRE)}else o=U(E,Y.OBNETDEB),s=U(E,Y.OBNETCRE),a=U(E,Y.OOBDEB),i=U(E,Y.OOBCRE);return[l,(b=c({},r),m={obnetdeb:o,obnetcre:s,oobdeb:a,oobcre:i,subTree:u},t(b,n(m)))];var b,m}));return Object.fromEntries(o)}function Z(e){let t,n,r;return n=new b({props:{color:e[0],size:e[1],unit:e[2]}}),{c(){t=m("div"),p(n.$$.fragment),this.h()},l(e){t=O(e,"DIV",{class:!0});var r=B(t);d(n.$$.fragment,r),r.forEach(g),this.h()},h(){h(t,"class","Spinner svelte-1hpylq3")},m(e,o){$(e,t,o),C(n,t,null),r=!0},p(e,[t]){const r={};1&t&&(r.color=e[0]),2&t&&(r.size=e[1]),4&t&&(r.unit=e[2]),n.$set(r)},i(e){r||(T(n.$$.fragment,e),r=!0)},o(e){N(n.$$.fragment,e),r=!1},d(e){e&&g(t),R(n)}}}function ee(e,t,n){let{color:r="white"}=t,{size:o="1"}=t,{unit:s="rem"}=t;return e.$$set=e=>{"color"in e&&n(0,r=e.color),"size"in e&&n(1,o=e.size),"unit"in e&&n(2,s=e.unit)},[r,o,s]}class te extends l{constructor(e){super(),f(this,e,ee,Z,E,{color:0,size:1,unit:2})}}export{X as B,te as S,w as a,K as b,D as c,Q as d,z as e,x as f,v as g,W as h,S as i,G as j,F as k,I as l,M as m,L as n,k as o,U as s,J as t};
